name: CI & Deploy to OVH VPS (Docker)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # test:
  #   name: Django checks
  #   runs-on: ubuntu-24.04

  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: "3.12"

  #     - name: Install system dependencies (GDAL)
  #       run: |
  #         sudo apt-get update
  #         sudo apt-get install -y build-essential gdal-bin libgdal-dev proj-bin libproj-dev libgeos-dev libspatialindex-dev curl 
  #         echo "CPLUS_INCLUDE_PATH=/usr/include/gdal" >> $GITHUB_ENV
  #         echo "C_INCLUDE_PATH=/usr/include/gdal" >> $GITHUB_ENV

  #     - name: Install Python dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -r requirements.txt

      # - name: Build .env
      #   run: |
      #     cat > .env <<EOF
      #     DJANGO_SETTINGS_MODULE=lignes_de_cretes.settings
      #     DEBUG=False
      #     DB_NAME=${{ secrets.DB_NAME }}
      #     DB_USER=${{ secrets.DB_USER }}
      #     DB_PASSWORD=${{ secrets.DB_PASSWORD }}
      #     DATABASE_HOST=${{ secrets.DATABASE_HOST }}
      #     GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
      #     EOF

      # - name: Django system checks
      #   env:
      #     DJANGO_SETTINGS_MODULE: lignes_de_cretes.settings
      #     SECRET_KEY: dummy-secret-for-ci
      #     DEBUG: "False"
      #   run: |
      #     python manage.py check
      #     python manage.py check --deploy

  deploy:
    name: Deploy to OVH VPS
    runs-on: ubuntu-24.04
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: SSH deploy to OVH VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          passphrase: ${{ secrets.SSH_KEY_PASSPHRASE }}
          script: |
            set -e

            # Dossier de ton projet sur le VPS
            APP_DIR=/var/www/lignes-de-cretes

            if [ ! -d "$APP_DIR" ]; then
              sudo mkdir -p "$APP_DIR"
              sudo chown -R $USER:$USER "$APP_DIR"
              cd "$APP_DIR"
              git clone https://github.com/${{ github.repository }} .
            else
              cd "$APP_DIR"
              git fetch origin
              git reset --hard origin/main
            fi

            cat > .env <<EOF
            DJANGO_SETTINGS_MODULE=lignes_de_cretes.settings
            DEBUG=False
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DATABASE_HOST=${{ secrets.DATABASE_HOST }}
            GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
            EOF

            # Build & restart des conteneurs

            docker compose pull || true
            docker compose build
            docker compose up -d --remove-orphans
